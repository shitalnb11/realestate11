{% extends 'base.html' %}
{% load static %}
{% block title %}Properties - Real Estate{% endblock %}

{% block content %}

<!-- ‚úÖ Header Section -->
<header class="text-center py-4" style="margin-top: 100px;">
  <h1 class="fw-bold text-dark">Properties for Sale in Pune</h1>
  <p class="text-muted">Find your dream home ‚Äî apartments, villas, and more in prime locations.</p>
</header>

<!-- ‚úÖ Filter Bar -->
<section class="filter-bar text-center mb-5 container bg-white shadow-sm p-4 rounded-4">
  <div class="row justify-content-center">
    <div class="col-md-6 mb-3">
      <input type="text" id="searchInput" class="form-control rounded-pill text-center py-2"
             placeholder="üîç Search by property or area..." autocomplete="off">
    </div>
  </div>
  <div class="d-flex justify-content-center gap-3 flex-wrap">
    <select id="priceFilter" class="form-select rounded-pill w-auto px-3">
      <option value="">Any Price</option>
      <option value="5000000">Below ‚Çπ50 Lakhs</option>
      <option value="10000000">‚Çπ50L - ‚Çπ1Cr</option>
      <option value="20000000">‚Çπ1Cr - ‚Çπ2Cr</option>
      <option value="30000000">Above ‚Çπ2Cr</option>
    </select>

    <select id="typeFilter" class="form-select rounded-pill w-auto px-3">
      <option value="">All Types</option>
      <optgroup label="Property Categories">
        <option value="apartment">Apartment</option>
        <option value="villa">Villa</option>
        <option value="penthouse">Penthouse</option>
        <option value="row house">Row House</option>
      </optgroup>
      <optgroup label="BHK Options">
        <option value="1bhk">1 BHK</option>
        <option value="2bhk">2 BHK</option>
        <option value="3bhk">3 BHK</option>
        <option value="4bhk">4 BHK</option>
      </optgroup>
    </select>

    <!-- Reset & Favorites -->
    <button class="btn btn-outline-danger rounded-pill px-4" onclick="resetFilters()">Reset</button>
    <button id="viewFavoritesBtn" class="btn btn-outline-primary rounded-pill px-4">
      ‚ù§Ô∏è My Favorites (<span id="favCount">0</span>)
    </button>
  </div>
</section>

<!-- ‚úÖ Property Grid -->
<div class="container">
  <div class="row" id="propertyGrid">
    {% for property in properties %}
    <div class="col-lg-4 col-md-6 mb-5 property-card-wrapper"
         data-title="{{ property.title|lower }}"
         data-location="{{ property.location|lower }}"
         data-price="{{ property.price }}"
         data-type="{{ property.property_type|lower }}">

      <div class="property-card shadow-lg position-relative rounded-4 overflow-hidden">

        <!-- ‚ù§Ô∏è Favorite Button -->
        <button class="favorite-btn" data-property-id="{{ property.id }}">
          <i class="far fa-heart"></i>
        </button>

        <!-- üèôÔ∏è Image Section -->
        <div class="property-image-wrapper position-relative">
          {% if property.image %}
            <img src="{{ property.image.url }}" class="property-img" alt="{{ property.title }}">
          {% else %}
            <img src="{% static 'img/default-property.jpg' %}" class="property-img" alt="No Image">
          {% endif %}
          <div class="property-type-badge">{{ property.property_type|title }}</div>
        </div>

        <!-- üè† Card Body -->
        <div class="property-content p-4 bg-white">
          <h5 class="fw-bold text-dark mb-2">{{ property.title }}</h5>

          <p class="text-muted small mb-2">
            <i class="fas fa-map-marker-alt text-danger location-icon me-2"
               style="cursor:pointer;"
               data-lat="{{ property.latitude }}"
               data-lng="{{ property.longitude }}"
               title="View on Google Maps"></i>
            {{ property.location }}
          </p>

          <!-- ‚≠ê Ratings -->
          <div class="rating-stars mb-2">
            {% if property.avg_rating %}
              {% for i in "12345" %}
                {% if forloop.counter <= property.avg_rating|floatformat:0 %}
                  <i class="fas fa-star text-warning"></i>
                {% else %}
                  <i class="far fa-star text-warning"></i>
                {% endif %}
              {% endfor %}
              <small class="text-muted ms-1">({{ property.avg_rating|floatformat:1 }}/5)</small>
            {% else %}
              <small class="text-muted">No Ratings Yet</small>
            {% endif %}
          </div>

          <!-- üí∞ Price -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fs-5 fw-semibold text-primary">‚Çπ{{ property.price }}</span>
            <span class="text-muted small">
              <i class="fas fa-bed text-secondary me-1"></i>{{ property.bedrooms|default:"--" }} Beds
            </span>
          </div>

          <!-- üîò Buttons -->
          <div class="d-flex justify-content-between">
            <a href="{% url 'property_detail' property.id %}" class="btn btn-gradient-blue btn-sm px-3 fw-semibold text-white">
              View Details
            </a>

            <button type="button"
                    class="btn btn-outline-primary btn-sm px-3 contact-agent-btn fw-semibold"
                    data-bs-toggle="modal"
                    data-bs-target="#agentModal"
                    data-agent-name="{{ property.seller.username }}"
                    data-agent-email="{{ property.seller.email }}"
                    data-agent-phone="{{ property.seller.phone|default:'Not available' }}">
              <i class="fas fa-user"></i> Contact
            </button>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
      <h4 class="text-muted">No Properties Available</h4>
    </div>
    {% endfor %}
  </div>
</div>

<!-- ‚úÖ Agent Info Modal -->
<div class="modal fade" id="agentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
      <div class="modal-header border-0 text-white py-3" 
           style="background: linear-gradient(90deg, #0061ff, #60efff);">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-user-tie me-2"></i> Agent Information
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center bg-light p-4">
        <div class="d-flex justify-content-center mb-3">
          <div class="p-1 bg-white rounded-circle shadow-sm">
            <img src="{% static 'img/agent-avatar.png' %}" 
                 alt="Agent Avatar" 
                 class="rounded-circle" 
                 width="100" height="100">
          </div>
        </div>
        <h5 id="agentName" class="fw-bold text-dark mb-1">Agent Name</h5>
        <p class="text-muted mb-1"><i class="fas fa-envelope text-primary me-2"></i><span id="agentEmail"></span></p>
        <p class="text-muted mb-3"><i class="fas fa-phone text-success me-2"></i><span id="agentPhone"></span></p>

        <div class="d-grid gap-2 mt-4">
          <a id="emailAgentBtn" href="#" class="btn btn-primary fw-semibold py-2 rounded-pill">
            ‚úâÔ∏è Send Email
          </a>
          <button type="button" class="btn btn-outline-secondary fw-semibold py-2 rounded-pill" data-bs-dismiss="modal">
            ‚ùå Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Modern Card CSS -->
<style>
.property-card {
  border: none;
  background: #fff;
  border-radius: 20px;
  overflow: hidden;
  transition: all 0.4s ease;
}
.property-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}
.property-image-wrapper {
  position: relative;
  overflow: hidden;
}
.property-img {
  width: 100%;
  height: 240px;
  object-fit: cover;
  transition: transform 0.5s ease;
}
.property-card:hover .property-img {
  transform: scale(1.08);
}
.property-type-badge {
  position: absolute;
  bottom: 15px;
  left: 15px;
  background: linear-gradient(90deg, #007bff, #00aaff);
  color: #fff;
  padding: 5px 12px;
  font-size: 13px;
  border-radius: 30px;
  font-weight: 500;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
}
.favorite-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  background: white;
  border: none;
  border-radius: 50%;
  padding: 8px 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 5;
  transition: 0.3s;
}
.favorite-btn i {
  font-size: 18px;
  color: #999;
}
.favorite-btn.active i {
  color: red;
}
.favorite-btn:hover {
  background: #f8f9fa;
}
.btn-gradient-blue {
  background: linear-gradient(90deg, #007bff, #00bfff);
  border: none;
  transition: 0.3s;
}
.btn-gradient-blue:hover {
  background: linear-gradient(90deg, #0066dd, #00a2e0);
}
.location-icon:hover {
  transform: scale(1.2);
  color: #007bff !important;
  transition: all 0.2s ease;
}
</style>

<!-- ‚úÖ JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const agentName = document.getElementById("agentName");
  const agentEmail = document.getElementById("agentEmail");
  const agentPhone = document.getElementById("agentPhone");
  const emailAgentBtn = document.getElementById("emailAgentBtn");
  const favCount = document.getElementById("favCount");
  const viewFavBtn = document.getElementById("viewFavoritesBtn");
  const favoritesKey = "favoriteProperties";
  let favorites = JSON.parse(localStorage.getItem(favoritesKey)) || [];
  let showingFavorites = false;

  function updateFavCount() {
    favCount.textContent = favorites.length;
  }
  updateFavCount();

  favorites.forEach(id => {
    const btn = document.querySelector(`.favorite-btn[data-property-id="${id}"]`);
    if (btn) {
      btn.classList.add("active");
      btn.querySelector("i").classList.replace("far", "fas");
    }
  });

  document.querySelectorAll(".contact-agent-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      agentName.textContent = this.dataset.agentName || "Not available";
      agentEmail.textContent = this.dataset.agentEmail || "Not available";
      agentPhone.textContent = this.dataset.agentPhone || "Not available";
      emailAgentBtn.href = "mailto:" + this.dataset.agentEmail;
    });
  });

  document.querySelectorAll(".favorite-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const id = this.dataset.propertyId;
      const icon = this.querySelector("i");
      if (favorites.includes(id)) {
        favorites = favorites.filter(f => f !== id);
        this.classList.remove("active");
        icon.classList.replace("fas", "far");
        if (showingFavorites) this.closest(".property-card-wrapper").style.display = "none";
      } else {
        favorites.push(id);
        this.classList.add("active");
        icon.classList.replace("far", "fas");
      }
      localStorage.setItem(favoritesKey, JSON.stringify(favorites));
      updateFavCount();
    });
  });

  viewFavBtn.addEventListener("click", function() {
    const cards = document.querySelectorAll(".property-card-wrapper");
    if (!showingFavorites) {
      if (favorites.length === 0) return alert("No favorites yet ‚ù§Ô∏è");
      cards.forEach(c => {
        const id = c.querySelector(".favorite-btn").dataset.propertyId;
        c.style.display = favorites.includes(id) ? "block" : "none";
      });
      viewFavBtn.textContent = "üîô Back to All";
      showingFavorites = true;
    } else {
      cards.forEach(c => c.style.display = "block");
      viewFavBtn.innerHTML = `‚ù§Ô∏è My Favorites (<span id="favCount">${favorites.length}</span>)`;
      showingFavorites = false;
      updateFavCount();
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // ‚úÖ Google Maps Click
  document.querySelectorAll(".location-icon").forEach(icon => {
    icon.addEventListener("click", function() {
      const lat = this.getAttribute("data-lat");
      const lng = this.getAttribute("data-lng");
      if (lat && lng) {
        window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank");
      } else {
        alert("Location coordinates not available.");
      }
    });
  });
});
</script> 

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
